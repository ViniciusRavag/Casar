<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nosso Casamento - Vini & Mylla</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #fdf2f8; }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day {
            aspect-ratio: 1/1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            font-size: 0.9rem;
        }
        .calendar-day:hover { background-color: #fce7f3; }
        .calendar-day.active { background-color: #db2777; color: white; font-weight: bold; box-shadow: 0 4px 6px -1px rgba(219, 39, 119, 0.4); }
        .calendar-day.has-task::after {
            content: '';
            position: absolute;
            bottom: 4px;
            width: 5px;
            height: 5px;
            background-color: #be185d;
            border-radius: 50%;
        }
        .calendar-day.active.has-task::after { background-color: white; }
        .calendar-day.empty { background: transparent; cursor: default; }
        
        /* Modal Animation */
        .modal { transition: opacity 0.3s ease, pointer-events 0.3s ease; opacity: 0; pointer-events: none; }
        .modal.open { opacity: 1; pointer-events: auto; }
        
        /* Toast Notification - Z-Index Aumentado para 9999 para garantir visibilidade */
        #toast {
            visibility: hidden;
            min-width: 280px;
            transform: translateX(-50%) translateY(-20px);
            opacity: 0;
            transition: all 0.3s ease-in-out;
            z-index: 9999 !important; /* Prioridade máxima */
        }
        #toast.show {
            visibility: visible;
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #db2777; border-radius: 4px; }
    </style>
</head>
<body class="text-gray-800 pb-20">

    <div id="toast" class="fixed top-5 left-1/2 bg-gray-900 text-white px-6 py-4 rounded-full shadow-2xl flex items-center gap-3 border border-gray-700">
        <div class="bg-green-500 rounded-full p-1">
            <i class="fa-solid fa-check text-white text-xs"></i>
        </div>
        <span id="toastMessage" class="text-sm font-bold tracking-wide">Sucesso!</span>
    </div>

    <header class="fixed top-0 w-full z-40 glass-effect shadow-sm">
        <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold text-pink-600"><i class="fa-solid fa-heart mr-2"></i>Vini & Mylla</h1>
                <p class="text-xs text-gray-500">Planejador de Casamento</p>
            </div>
            <div class="text-right">
                <div class="text-xs text-gray-500">Total Pago</div>
                <div class="text-sm font-bold text-green-600" id="headerTotalPaid">R$ 0,00</div>
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto mt-20 px-4">
        
        <div class="flex justify-between items-center mb-4 bg-white p-3 rounded-2xl shadow-sm">
            <button id="prevMonth" class="p-2 text-pink-600 hover:bg-pink-50 rounded-full"><i class="fa-solid fa-chevron-left"></i></button>
            <h2 id="currentMonthYear" class="font-bold text-lg capitalize">Janeiro 2026</h2>
            <button id="nextMonth" class="p-2 text-pink-600 hover:bg-pink-50 rounded-full"><i class="fa-solid fa-chevron-right"></i></button>
        </div>

        <div class="bg-white rounded-2xl shadow-sm p-3 mb-6">
            <div class="grid grid-cols-7 gap-1 mb-2 text-center text-xs text-gray-400 font-bold">
                <div>D</div><div>S</div><div>T</div><div>Q</div><div>Q</div><div>S</div><div>S</div>
            </div>
            <div id="calendarGrid" class="calendar-grid"></div>
        </div>

        <div class="mb-6 bg-white p-4 rounded-2xl shadow-sm">
            <div class="relative mb-3">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-400"></i>
                <input type="text" id="searchInput" placeholder="Buscar tarefa ou fornecedor..." class="w-full bg-gray-50 border border-gray-100 rounded-xl pl-10 pr-4 py-2 text-sm focus:outline-none focus:border-pink-400 transition">
            </div>
            <div class="flex gap-2">
                <select id="filterType" class="flex-1 bg-gray-50 border border-gray-100 rounded-lg px-2 py-2 text-xs text-gray-600 focus:outline-none focus:border-pink-400">
                    <option value="">Todas Categorias</option>
                    <option>Cerimônia</option>
                    <option>Festa</option>
                    <option>Documentação</option>
                    <option>Lua de Mel</option>
                    <option>Outros</option>
                </select>
                <select id="filterStatus" class="flex-1 bg-gray-50 border border-gray-100 rounded-lg px-2 py-2 text-xs text-gray-600 focus:outline-none focus:border-pink-400">
                    <option value="">Todos Status</option>
                    <option value="Ainda não fez (Urgente)">Urgente</option>
                    <option value="Dentro do prazo">No Prazo</option>
                    <option value="Feito">Feito</option>
                    <option value="Passou a data">Atrasado</option>
                </select>
            </div>
            <div id="searchResetBtn" class="hidden mt-2 text-center">
                <button class="text-xs text-pink-600 font-bold underline cursor-pointer">Limpar filtros e voltar para Hoje</button>
            </div>
        </div>

        <div class="mb-4 flex justify-between items-end">
            <h3 class="font-bold text-gray-700">Tarefas: <span id="selectedDateLabel" class="text-pink-600">Hoje</span></h3>
            <span id="taskCount" class="text-xs bg-pink-100 text-pink-600 px-2 py-1 rounded-full font-bold">0 tarefas</span>
        </div>

        <div id="taskList" class="space-y-3 pb-10">
            </div>
    </main>

    <button id="fabAdd" class="fixed bottom-6 right-6 bg-pink-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-pink-700 transition-colors z-30">
        <i class="fa-solid fa-plus"></i>
    </button>

    <div id="taskModal" class="modal fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md h-[90vh] sm:h-auto sm:rounded-2xl rounded-t-3xl p-6 overflow-y-auto relative shadow-2xl">
            
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800" id="modalTitle">Nova Tarefa</h3>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>

            <form id="taskForm" class="space-y-4">
                <input type="hidden" id="taskId">

                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">O que fazer?</label>
                        <input type="text" id="inpTask" placeholder="Ex: Degustação Buffet" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-pink-500" required>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Tipo</label>
                        <select id="inpType" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-3 text-sm focus:outline-none focus:border-pink-500">
                            <option>Cerimônia</option>
                            <option>Festa</option>
                            <option>Documentação</option>
                            <option>Lua de Mel</option>
                            <option>Outros</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Data</label>
                        <input type="date" id="inpDate" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-3 text-sm focus:outline-none focus:border-pink-500" required>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Fornecedor / Local</label>
                    <input type="text" id="inpVendor" placeholder="Ex: Buffet Estrela" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-pink-500">
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Detalhes</label>
                    <textarea id="inpDetails" rows="2" placeholder="Detalhes importantes..." class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-pink-500"></textarea>
                </div>

                <div class="bg-pink-50 p-4 rounded-xl border border-pink-100">
                    <h4 class="text-xs font-bold text-pink-600 mb-3 uppercase tracking-wide">Financeiro</h4>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-xs text-gray-500">Valor Total (R$)</label>
                            <input type="number" step="0.01" id="inpValue" class="calc-input w-full border border-gray-200 rounded-lg p-2 text-sm" placeholder="0,00">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500">Já Pago / Entrada (R$)</label>
                            <input type="number" step="0.01" id="inpPaid" class="calc-input w-full border border-gray-200 rounded-lg p-2 text-sm" placeholder="0,00">
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t border-pink-200">
                        <span class="text-sm font-bold text-gray-600">Falta Pagar:</span>
                        <span id="displayRemaining" class="text-lg font-bold text-red-500">R$ 0,00</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Responsável</label>
                        <select id="inpResponsible" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-3 text-sm focus:outline-none focus:border-pink-500">
                            <option value="Vinicius">Vinicius</option>
                            <option value="Mylla">Mylla</option>
                            <option value="Ambos">Ambos</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Status</label>
                        <select id="inpStatus" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-3 text-sm focus:outline-none focus:border-pink-500">
                            <option value="Ainda não fez (Urgente)">Urgente</option>
                            <option value="Dentro do prazo" selected>No Prazo</option>
                            <option value="Feito">Feito</option>
                            <option value="Passou a data">Atrasado</option>
                        </select>
                    </div>
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" id="btnDelete" class="hidden flex-1 bg-red-100 text-red-600 py-3 rounded-xl font-bold hover:bg-red-200 transition">Excluir</button>
                    <button type="submit" id="btnSave" class="flex-grow-[2] bg-pink-600 text-white py-3 rounded-xl font-bold hover:bg-pink-700 transition shadow-lg shadow-pink-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fa-solid fa-save mr-2"></i><span id="btnSaveText">Salvar Tarefa</span>
                    </button>
                </div>
            </form>
            <div class="h-10 sm:h-0"></div> </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO DO FIREBASE (SUBSTITUA AQUI) ---
        const firebaseConfig = {
            apiKey: "SUA_API_KEY_AQUI",
            authDomain: "SEU_PROJETO.firebaseapp.com",
            projectId: "SEU_PROJECT_ID",
            storageBucket: "SEU_PROJETO.firebasestorage.app",
            messagingSenderId: "SEU_SENDER_ID",
            appId: "SEU_APP_ID"
        };
        // -------------------------------------------------

        // Inicializar Firebase
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch (e) {
            console.error("Erro ao conectar Firebase.", e);
            alert("Erro: Configure as chaves do Firebase no código.");
        }

        // Variáveis de Estado
        let currentDate = new Date();
        let selectedDate = new Date(); 
        let allTasks = [];
        const taskCollection = collection(db, "wedding_tasks");

        // Elementos DOM
        const calendarGrid = document.getElementById('calendarGrid');
        const currentMonthYearEl = document.getElementById('currentMonthYear');
        const taskListEl = document.getElementById('taskList');
        const taskCountEl = document.getElementById('taskCount');
        const modal = document.getElementById('taskModal');
        const form = document.getElementById('taskForm');
        
        // Elementos do Botão Salvar
        const btnSave = document.getElementById('btnSave');
        const btnSaveText = document.getElementById('btnSaveText');
        
        // Elementos de Pesquisa
        const searchInput = document.getElementById('searchInput');
        const filterType = document.getElementById('filterType');
        const filterStatus = document.getElementById('filterStatus');
        const searchResetBtn = document.getElementById('searchResetBtn');
        const selectedDateLabel = document.getElementById('selectedDateLabel');

        // Elementos de Cálculo
        const inpValue = document.getElementById('inpValue');
        const inpPaid = document.getElementById('inpPaid');
        const displayRemaining = document.getElementById('displayRemaining');

        // --- HELPERS DE DATA CORRIGIDOS ---
        function getLocalYMD(dateObj) {
            const y = dateObj.getFullYear();
            const m = String(dateObj.getMonth() + 1).padStart(2, '0');
            const d = String(dateObj.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        // Escutar Mudanças no Banco de Dados
        const q = query(taskCollection, orderBy("date", "asc"));
        onSnapshot(q, (snapshot) => {
            allTasks = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            renderCalendar();
            renderTasks();
            updateHeaderStats();
        });

        // --- FUNÇÕES DE VISUALIZAÇÃO ---

        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.innerText = message;
            toast.classList.add('show');
            
            // Remove após 3 segundos
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function renderCalendar() {
            calendarGrid.innerHTML = '';
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            const monthName = new Intl.DateTimeFormat('pt-BR', { month: 'long' }).format(currentDate);
            currentMonthYearEl.innerText = `${monthName} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                const div = document.createElement('div');
                div.className = 'calendar-day empty';
                calendarGrid.appendChild(div);
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const thisDate = new Date(year, month, i);
                const dateStr = getLocalYMD(thisDate);
                
                const div = document.createElement('div');
                div.className = 'calendar-day';
                div.innerText = i;

                const hasTask = allTasks.some(t => t.date === dateStr);
                if (hasTask) div.classList.add('has-task');

                const selStr = getLocalYMD(selectedDate);
                if (dateStr === selStr) div.classList.add('active');

                div.addEventListener('click', () => {
                    selectedDate = new Date(year, month, i);
                    clearFilters(false);
                    renderCalendar();
                    renderTasks();
                });

                calendarGrid.appendChild(div);
            }
        }

        function renderTasks() {
            const queryText = searchInput.value.toLowerCase();
            const typeVal = filterType.value;
            const statusVal = filterStatus.value;
            
            let filteredTasks = [];
            let isFiltering = (queryText !== '' || typeVal !== '' || statusVal !== '');

            if (isFiltering) {
                filteredTasks = allTasks.filter(task => {
                    const matchesText = (task.task || '').toLowerCase().includes(queryText) || 
                                      (task.vendor || '').toLowerCase().includes(queryText);
                    const matchesType = typeVal ? task.type === typeVal : true;
                    const matchesStatus = statusVal ? task.status === statusVal : true;
                    return matchesText && matchesType && matchesStatus;
                });
                
                selectedDateLabel.innerText = "Resultado da Pesquisa";
                searchResetBtn.classList.remove('hidden');
                
                const activeDay = document.querySelector('.calendar-day.active');
                if(activeDay) activeDay.classList.remove('active');

            } else {
                const dateStr = getLocalYMD(selectedDate);
                filteredTasks = allTasks.filter(t => t.date === dateStr);
                
                const day = selectedDate.getDate();
                const month = new Intl.DateTimeFormat('pt-BR', { month: 'long' }).format(selectedDate);
                selectedDateLabel.innerText = `${day} de ${month}`;
                searchResetBtn.classList.add('hidden');
            }
            
            taskCountEl.innerText = `${filteredTasks.length} tarefas`;
            taskListEl.innerHTML = '';

            if (filteredTasks.length === 0) {
                taskListEl.innerHTML = `
                    <div class="text-center py-10 text-gray-400">
                        <i class="fa-solid fa-magnifying-glass text-4xl mb-2 opacity-20"></i>
                        <p class="text-sm">${isFiltering ? 'Nenhum resultado encontrado.' : 'Nada agendado para este dia.'}</p>
                        ${!isFiltering ? '<button onclick="document.getElementById(\'fabAdd\').click()" class="text-pink-600 text-xs font-bold mt-2 underline">Adicionar tarefa</button>' : ''}
                    </div>`;
                return;
            }

            filteredTasks.forEach(task => {
                const remaining = (parseFloat(task.value || 0) - parseFloat(task.paid || 0));
                
                let statusColor = 'bg-gray-100 text-gray-600';
                let icon = 'fa-clock';
                if(task.status.includes('Urgente')) { statusColor = 'bg-red-100 text-red-600'; icon = 'fa-triangle-exclamation'; }
                else if(task.status === 'Feito') { statusColor = 'bg-green-100 text-green-600'; icon = 'fa-check'; }
                else if(task.status === 'Passou a data') { statusColor = 'bg-orange-100 text-orange-600'; icon = 'fa-calendar-xmark'; }

                const dateParts = task.date.split('-');
                const dateBr = `${dateParts[2]}/${dateParts[1]}`;

                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative group overflow-hidden transition hover:shadow-md cursor-pointer';
                card.onclick = (e) => openModal(task);

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[10px] font-bold tracking-wider uppercase text-gray-400 border border-gray-200 px-1 rounded">${task.type}</span>
                                ${isFiltering ? `<span class="text-[10px] font-bold text-pink-600 bg-pink-50 px-1 rounded"><i class="fa-regular fa-calendar mr-1"></i>${dateBr}</span>` : ''}
                            </div>
                            <h4 class="font-bold text-gray-800 leading-tight">${task.task}</h4>
                        </div>
                        <span class="text-[10px] px-2 py-1 rounded-full font-bold flex items-center gap-1 ${statusColor}">
                            <i class="fa-solid ${icon}"></i> ${task.status}
                        </span>
                    </div>
                    
                    <div class="text-sm text-gray-500 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-store text-pink-400 text-xs"></i> ${task.vendor || 'Sem fornecedor'}
                    </div>

                    <div class="bg-gray-50 rounded-lg p-2 flex justify-between items-center text-xs">
                        <div>
                            <p class="text-gray-400">Responsável</p>
                            <p class="font-bold text-gray-700">${task.responsible}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-gray-400">Falta Pagar</p>
                            <p class="font-bold ${remaining > 0 ? 'text-red-500' : 'text-green-500'}">
                                ${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(remaining)}
                            </p>
                        </div>
                    </div>
                `;
                taskListEl.appendChild(card);
            });
        }

        // --- LÓGICA DE FILTRO ---
        function clearFilters(shouldRender = true) {
            searchInput.value = '';
            filterType.value = '';
            filterStatus.value = '';
            if(shouldRender) {
                renderCalendar(); 
                renderTasks();
            }
        }

        searchInput.addEventListener('input', renderTasks);
        filterType.addEventListener('change', renderTasks);
        filterStatus.addEventListener('change', renderTasks);
        searchResetBtn.querySelector('button').addEventListener('click', () => clearFilters(true));


        // --- FUNÇÕES DE MODAL ---
        function openModal(task = null) {
            form.reset();
            document.getElementById('displayRemaining').innerText = 'R$ 0,00';
            const btnDelete = document.getElementById('btnDelete');
            
            // Reseta o botão de salvar para o estado original
            btnSave.disabled = false;
            btnSaveText.innerText = 'Salvar Tarefa';

            if (task) {
                document.getElementById('modalTitle').innerText = 'Editar Tarefa';
                document.getElementById('taskId').value = task.id;
                document.getElementById('inpTask').value = task.task;
                document.getElementById('inpType').value = task.type;
                document.getElementById('inpDate').value = task.date;
                document.getElementById('inpVendor').value = task.vendor;
                document.getElementById('inpDetails').value = task.details;
                document.getElementById('inpValue').value = task.value;
                document.getElementById('inpPaid').value = task.paid;
                document.getElementById('inpResponsible').value = task.responsible;
                document.getElementById('inpStatus').value = task.status;
                
                updateRemainingCalc();
                btnDelete.classList.remove('hidden');
                btnDelete.onclick = () => handleDelete(task.id);
            } else {
                document.getElementById('modalTitle').innerText = 'Nova Tarefa';
                document.getElementById('taskId').value = '';
                document.getElementById('inpDate').value = getLocalYMD(selectedDate);
                btnDelete.classList.add('hidden');
            }
            modal.classList.add('open');
        }

        function closeModalFunc() {
            modal.classList.remove('open');
        }

        // --- CRUD COM FEEDBACK INSTANTANEO ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // 1. Estado de Carregamento (Feedback Visual)
            btnSave.disabled = true;
            btnSaveText.innerText = 'Salvando...';

            const id = document.getElementById('taskId').value;
            
            const data = {
                task: document.getElementById('inpTask').value,
                type: document.getElementById('inpType').value,
                date: document.getElementById('inpDate').value,
                vendor: document.getElementById('inpVendor').value,
                details: document.getElementById('inpDetails').value,
                value: parseFloat(document.getElementById('inpValue').value) || 0,
                paid: parseFloat(document.getElementById('inpPaid').value) || 0,
                responsible: document.getElementById('inpResponsible').value,
                status: document.getElementById('inpStatus').value
            };

            try {
                // 2. Operação no Firebase
                if (id) {
                    await updateDoc(doc(db, "wedding_tasks", id), data);
                    // 3. Feedback de Sucesso
                    showToast("Tarefa atualizada com sucesso!");
                } else {
                    await addDoc(taskCollection, data);
                    // 3. Feedback de Sucesso
                    showToast("Tarefa cadastrada com sucesso!");
                }
                
                // 4. Fechar Modal Imediatamente após sucesso
                closeModalFunc();

            } catch (error) {
                console.error("Erro ao salvar:", error);
                alert("Erro ao salvar tarefa. Tente novamente.");
            } finally {
                // Restaura o botão (caso o modal seja reaberto rapidamente)
                btnSave.disabled = false;
                btnSaveText.innerText = 'Salvar Tarefa';
            }
        });

        async function handleDelete(id) {
            if(confirm("Tem certeza que deseja excluir esta tarefa?")) {
                await deleteDoc(doc(db, "wedding_tasks", id));
                showToast("Tarefa excluída.");
                closeModalFunc();
            }
        }

        // --- UTILITÁRIOS ---
        function updateRemainingCalc() {
            const val = parseFloat(inpValue.value) || 0;
            const pd = parseFloat(inpPaid.value) || 0;
            const rem = val - pd;
            displayRemaining.innerText = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(rem);
            if(rem <= 0) displayRemaining.classList.replace('text-red-500', 'text-green-500');
            else displayRemaining.classList.replace('text-green-500', 'text-red-500');
        }

        function updateHeaderStats() {
            const totalPaid = allTasks.reduce((acc, t) => acc + (parseFloat(t.paid) || 0), 0);
            document.getElementById('headerTotalPaid').innerText = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(totalPaid);
        }

        // Listeners Globais
        inpValue.addEventListener('input', updateRemainingCalc);
        inpPaid.addEventListener('input', updateRemainingCalc);
        document.getElementById('fabAdd').addEventListener('click', () => openModal(null));
        document.getElementById('closeModal').addEventListener('click', closeModalFunc);
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });
        document.getElementById('nextMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        // Inicializar
        renderCalendar();
    </script>
</body>
</html>
